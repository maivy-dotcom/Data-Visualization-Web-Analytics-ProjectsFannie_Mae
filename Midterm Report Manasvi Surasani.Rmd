---
title: "Default Patterns in Fannie Mae's Fixed-Rate Single-Family Mortgages"
subtitle: "A Comparative Analysis of 2007 and 2019"
author: Manasvi Surasani
format: html
output: bookdown::html_document2
toc: false
editor: visual
---

```{=html}
<!This block assists in formatting the title, font size, chart caption, etc.– –>
<style type="text/css">
  .title {
    text-align: left;
}
body{ /* Normal  */
      font-size: 16px;
      margin: 2.5cm;
      top: 1.5cm;
      text-align: justify;
  }
  .caption {
    font-size: big;
    text-align: center;
    position: above;
}
</style>
```

```{css plotly-caption, echo = FALSE}
/*Include this block if you like the chart caption at the top instead of the bottom.*/
div.figure {
  display: table;
}
div.figure p {
  display: table-caption;
  caption-side: top;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

------------------------------------------------------------------------

The mortgage market has experienced significant shifts over the past few
decades, driven by changing economic conditions, market dynamics, and
regulatory responses. One key area of focus has been mortgage default
rates, which serve as a crucial indicator of the health and stability of
the housing market. Fannie Mae's mortgage default rates, spanning from
1999 to 2023, offer a valuable lens through which we can examine these
changes. This analysis explores how lending practices, borrower
characteristics, and macroeconomic factors have evolved, particularly
during two critical periods: the 2007-2009 financial crisis and the
post-crisis period in 2019. By examining key factors such as credit
scores, loan-to-value (LTV) ratios, debt-to-income (DTI) ratios, and
first-time home buyer trends, we can gain insights into the underlying
drivers of mortgage default rates and the effectiveness of policy
reforms aimed at improving market stability.

The time series analysis of Fannie Mae's mortgage default rates from
1999 to 2023 reveals dramatic shifts in loan performance across
different economic cycles (Figure \@ref(fig:Time-series-default-rates)).
During the dot-com bubble (2000-2002), default rates remained relatively
stable under 2%. However, the 2007-2009 financial crisis saw rates spike
to approximately 8%, leading to significant market distress. The
subsequent recovery period showed a steady decline in default rates,
stabilizing below 1% by 2019. Notably, this improved performance
persisted even through the COVID-19 pandemic, suggesting robust reforms
in lending practices. To better understand these improvements, this
analysis examines loan characteristics during two critical periods:
2007, representing peak crisis conditions, and 2019, demonstrating
reformed lending practices that were subsequently tested by the
pandemic.\
\
The analysis of credit score patterns shows a marked shift in lending
practices (Figure \@ref(fig:box-plot-credit-score)). The 2007 data shows
a broader distribution with a significant portion of loans in the
620-680 range. Notably, loans that defaulted had significantly lower
average credit scores, highlighting the importance of this metric in
predicting default risk. In contrast, 2019 demonstrates a concentrated
distribution in the 740-780 range, reflecting stricter credit quality
requirements and improved risk assessment practices.\
\
Examining LTV ratios reveals crucial risk patterns in lending practices
(Figure \@ref(fig:density-chart-LTV)). The 2007 data shows two
concerning spikes: a major concentration at 80% LTV and another
substantial peak at 90% LTV, indicating high-risk exposure. By 2019,
while similar concentration points existed at these LTV levels, the
magnitude of these spikes was considerably smaller, suggesting more
balanced and conservative lending practices.\
\
The relationship between DTI ratios and default rates shows significant
improvement over time (Figure \@ref(fig:couple-chart-DTI)). Higher DTI
ratios (\>45%) in 2007 corresponded with default rates exceeding 12%.
Importantly, there were many loans with DTI ratios above 51% in 2007, a
level that was barely seen in 2019. The 2019 data showed default rates
below 3% and a much tighter control on high DTI ratios, indicating more
effective assessment of borrower repayment capacity.\
\
Default patterns among first-time home buyers reveal an interesting
trend (Figure \@ref(fig:stacked-chart-homeOwners)). Contrary to
conventional expectations, the data shows that first-time home buyers
actually demonstrated lower average default rates. This
counter-intuitive finding likely reflects the implementation of stricter
risk assessment principles for this borrower segment, resulting in more
careful screening and better loan performance. The increased proportion
of first-time home buyers in 2019, combined with stricter criteria for
non-first-time buyers, appears to have contributed to overall lower
default rates.\
\
The examination of loan purposes reveals varying risk levels across
different loan types (Figure \@ref(fig:interactive-chart-purpose)).
Cash-out refinances in 2007 showed the highest default rates (\>10%),
while purchase loans demonstrated lower risk. By 2019, default rates
across all purposes converged to below 2%, suggesting more uniform risk
assessment regardless of loan purpose.\
\
The analysis identifies significant improvements in default risk
management between these two periods. The data reveals strong
correlations between default rates and traditional risk metrics (credit
scores, LTV, DTI), while highlighting the effectiveness of post-2008
reforms. The stability observed during COVID-19 validates the improved
risk assessment framework, as evidenced by consistent performance across
all loan characteristics in the 2019 data. These insights suggest that
maintaining the current risk assessment framework, with its emphasis on
higher credit quality, lower leverage levels, and stricter criteria for
all borrower segments, is crucial for continued market stability. The
success in managing risk for first-time home buyers demonstrates that
tailored, stringent approaches can effectively expand home ownership
while maintaining low default rates.

\
(Word count: 689)

<br>

### Figure Appendix {.unnumbered}

```{r, include = FALSE}
# We first load in the packages and data.
library(tidyverse);
library(zoo);
library(patchwork); # package for combining charts
library(plotly); # package for simple interactive charts
library(ggiraph); # package for advanced interactive charts
library(usmap);
library(scales);
data_2007 <- read_rds("data_sample_2007Q4.rds")
data_2019 <- read_rds("data_sample_2019Q4.rds")
default_rate_ts <- read_csv("default_rate_ts.csv")

data_2007$YEAR <- 2007
data_2019$YEAR <- 2019
combined_data <- rbind(data_2007, data_2019)
```

```{r Time-series-default-rates, echo = FALSE, fig.width=8, fig.height = 4, fig.cap="Sharp spike in default rate during the 2008 financial crisis"}
default_rate_ts <- default_rate_ts %>%
  mutate(Date = as.Date(Date, format = "%m/%d/%Y"),
         `Default rate` = `Default rate` * 100)

time_series_chart <- default_rate_ts %>%
  ggplot(aes(x = Date, y =`Default rate`)) +
  geom_line() + 
  geom_point() +
  geom_vline(xintercept = as.Date(c("2008-09-15", "2020-03-01")), 
             linetype = "dashed", color = "black") +
  geom_text(x = as.Date("2008-06-01"), y = max(default_rate_ts$`Default rate`)*0.6, 
           label = "2008 Global Financial Crisis", angle = 90, vjust = 0, size = 4, color = "#FF69B4" ) +
  geom_text(x = as.Date("2020-01-01"), y = max(default_rate_ts$`Default rate`)*0.6, 
           label = "COVID-19", angle = 90, vjust = 0, size = 4, color="steelblue") +
  labs(x = '',y = 'Default rate(%)') +
  theme_bw() +
  theme(axis.text = element_text(size = 10),
        axis.text.x = element_text(angle = 0, hjust = 0.5),
        axis.title = element_text(size = 10),
        panel.grid.major.y = element_line(color='grey85'),
        panel.grid = element_blank()) +
  scale_x_date(date_breaks = "4 year", date_labels = "%Y") +
  scale_y_continuous(labels = scales::percent_format(scale = 1))
time_series_chart
```

<br>

```{r box-plot-credit-score, echo = FALSE, fig.width=10, fig.height = 4, fig.cap="Borrower Credit Score Comparison across defaulters vs non-defaulters (2007 vs. 2019)"}
boxplot_data <- ggplot(combined_data, aes(x = factor(YEAR), y = CSCORE_B, fill = factor(YEAR))) +
  geom_boxplot() +
  labs(title = "", x = "Overall", y = "Credit Score of Borrower") +
  theme_bw() +
  scale_fill_manual(values = c("2007" = "pink", "2019" = "lightblue")) +
  theme(axis.title.x = element_text(margin = margin(t = 10)),
        panel.grid.major.y = element_line(color = "grey95"),
        panel.grid = element_blank(),
        legend.position = "none") +
  scale_x_discrete(limits = c("2007", "2019")) +
  coord_cartesian(ylim = c(500,800))

boxplot_data_2007 <- data_2007 %>%
  ggplot(aes(x = factor(DEFAULT_FLAG), y = CSCORE_B)) +
  geom_boxplot(fill = "pink", color = "black", alpha = 0.7) + 
  labs(title = "", x = "2007", y = "") +
  theme_bw() +
  theme(plot.title = element_text(size = 12),
        axis.title.x = element_text(margin = margin(t = 10)), 
        panel.grid.major.y = element_line(color = "grey95"),
        panel.grid = element_blank()) + 
  scale_x_discrete(labels = c("No Default", "Default")) +
  coord_cartesian(ylim = c(500,800))

boxplot_data_2019 <- data_2019 %>%
  ggplot(aes(x = factor(DEFAULT_FLAG), y = CSCORE_B)) +
  geom_boxplot(fill = "lightblue", color = "black", alpha = 0.7) + 
  labs(title = "", x = "2019", y = "") +
  theme_bw() +
  theme(axis.title.x = element_text(margin = margin(t = 10)), 
        panel.grid.major.y = element_line(color = "grey95"),
        panel.grid = element_blank()) + 
  scale_x_discrete(labels = c("No Default", "Default")) +
  coord_cartesian(ylim = c(500,800))

boxplot_data + boxplot_data_2007 + boxplot_data_2019
```

<br>

```{r density-chart-LTV, echo = FALSE, fig.width=8, fig.height = 4, fig.cap="Loan-to-value Ratio Distribution (2007 vs. 2019) showing higher risk profiles in 2007"}
density_plot <- ggplot(combined_data, aes(x = OLTV, fill = factor(YEAR), color = factor(YEAR))) +
  geom_density(alpha = 0.5, size = 1.2) +
  labs(title = "", x = "Loan-to-Value Ratio", y = "Density", 
       fill = "Year", color = "Year") +
  theme_bw() +
  theme(axis.title.x = element_text(margin = margin(t = 10)), 
        panel.grid.major.y = element_line(color = "grey95"),
        panel.grid = element_blank()) + 
  scale_fill_manual(values = c("2007" = "pink", "2019" = "lightblue")) +  
  scale_color_manual(values = c("2007" = "pink", "2019" = "lightblue"))
density_plot
```

<br>

```{r couple-chart-DTI, echo = FALSE, fig.width=8, fig.height = 8, fig.cap="Higher occurences of loans with >51% DTI in 2007 "}
# Define DFI buckets, calculate Average Default Rate for Each Bucket and Year
df_summary <- combined_data %>% 
  mutate(DTI_BUCKET = cut(DTI, breaks = seq(0, 70, by = 10), right = FALSE, 
                          labels = paste0(seq(1, 61, by = 10), "-", seq(10, 70, by = 10),"%"))) %>%
  drop_na(DTI_BUCKET) %>%
  filter(YEAR %in% c(2007, 2019)) %>%  
  group_by(YEAR, DTI_BUCKET) %>%
  summarise(avg_default_rate = mean(DEFAULT_FLAG), 
            count = n(), .groups = 'drop') %>%
  complete(YEAR, DTI_BUCKET, fill = list(avg_default_rate = 0, count = 0))

# Plot Comparison of DTI vs. Frequency
dti_frequency_plot <- ggplot(df_summary, aes(x = DTI_BUCKET, y = count, fill = as.factor(YEAR))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "", x = "", y = "Frequency", fill = "Year") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10),
        axis.title = element_text(size = 10),
        plot.title = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 9),
        panel.grid.major.y = element_line(color='grey85'),
        panel.grid = element_blank(),
        legend.position = "none") + 
  scale_fill_manual(values = c("2007" = "pink", "2019" = "lightblue"))

dti_default_plot <- ggplot(df_summary, aes(x = DTI_BUCKET, y = avg_default_rate, 
                                           fill = as.factor(YEAR))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "", x = "Debt-to-Income Ratio", y = "Average Default rate",
       fill = "Year") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 10),
        plot.title = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 9),
        panel.grid.major.y = element_line(color='grey85'),
        panel.grid = element_blank()) +
  scale_fill_manual(values = c("2007" = "pink", "2019" = "lightblue")) +
  scale_y_continuous(labels = scales::percent_format(scale = 100))

(dti_plot <- (dti_frequency_plot/dti_default_plot))
```

<br>

```{r stacked-chart-homeOwners, echo = FALSE, fig.width=10, fig.height = 4, fig.cap="First time home owners have lower default rates due to stricter risk principles"}
# Left Chart: Average Default Rate by First-Time Homeowner Status(Across both years)
left_chart<- combined_data %>%
  mutate(FIRST_FLAG = as.factor(FIRST_FLAG)) %>%
  filter(FIRST_FLAG %in% c('Y','N')) %>%
  group_by(FIRST_FLAG) %>%
  summarise(avg_default_rate = mean(DEFAULT_FLAG, na.rm = TRUE), count = n()) %>%
  ggplot(aes(x = FIRST_FLAG, y = avg_default_rate, fill = FIRST_FLAG)) +
  geom_bar(stat = "identity") +
  labs(title = "",
       x = "", y = "Avg Default Rate") +
  scale_fill_manual(values = c("Y" = "lavender", "N" = "grey65")) +
  scale_x_discrete(labels = c("Y" = "Yes", "N" = "No")) +
  theme_bw() +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 10),
        plot.title = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 9),
        panel.grid.major.y = element_line(color='grey85'),
        panel.grid = element_blank()) +
  theme(legend.position = "none") 

# Right chart: Percentage of first time owners versus not in 2007 vs 2019
right_chart <- combined_data %>%
  filter(YEAR %in% c(2007, 2019)) %>%
  group_by(YEAR, FIRST_FLAG) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(prop = count / sum(count)) %>%  # Proportion relative to total count
  ggplot(aes(x = as.factor(YEAR), y = prop, fill = FIRST_FLAG)) +
  geom_bar(stat = "identity", position = "fill") +  
  labs(title = "", x = "", y = "Proportion of Borrowers") +
  scale_fill_manual(values = c("Y" = "lavender", "N" = "grey65"), 
                    name = "First-time Homeowner?", labels = c("Y" = "Yes", "N" = "No")) +
  theme_bw() +
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 10),
        plot.title = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major.y = element_line(color='grey85'),
        panel.grid = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 100))   

# Combine both plots side by side
left_chart + right_chart
```

<br>

```{r interactive-chart-purpose, echo = FALSE, fig.width=8, fig.height = 4, fig.cap="Default rates stabilised to below 0.3% across all loan types in 2019"}
# Prepare the data
purpose_data <- combined_data %>%
  group_by(YEAR, PURPOSE) %>%
  summarize(
    count = n(),
    default_rate = mean(DEFAULT_FLAG)
  ) %>%
  group_by(YEAR) %>%
  mutate(proportion = count / sum(count),
         PURPOSE = recode(PURPOSE, 
                          "C" = "Cash-Out Refinance", 
                          "P" = "Purchase", 
                          "R" = "Refinance"))

# Create the stacked bar chart
purpose_chart <- ggplot(purpose_data, aes(x = factor(YEAR), y = proportion, fill = PURPOSE, 
                        text = paste("Purpose:", PURPOSE,
                              "<br>Proportion:", scales::percent(proportion, accuracy=0.1),
                              "<br>Default Rate:",scales::percent(default_rate, accuracy=0.1)))) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_brewer(palette = "Set3", name = "Loan Purpose") +
  labs(title = "", x = "", y = "Proportion of Loans",  fill = "Loan Purpose") +
  theme_bw() +
  theme(axis.text = element_text(size = 9),
        axis.title = element_text(size = 10),
        plot.title = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major.y = element_line(color='grey85'),
        panel.grid = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(scale = 100))  

interactive_plot <- ggplotly(purpose_chart,tooltip = "text") %>%
  layout(hoverlabel = list(bgcolor ="white"),
         showlegend = TRUE)

interactive_plot
```
